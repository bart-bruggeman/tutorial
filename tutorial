#!/bin/bash
set -e  # Stop bij fouten
set -u  # Stop bij gebruik van niet-gedefinieerde variabelen

# versies
SAXON_HE_VERSION="12.8"
XML_RESOLVER_VERSION="5.3.3"
XMLVALIDATOR_VERSION="1.0-SNAPSHOT"
YUI_COMPRESSOR_VERSION="2.4.8"
HTML_COMPRESSOR_VERSION="1.5.2"

# directories
SAXON_HE_HOME="library/saxon-he-${SAXON_HE_VERSION}"
XMLVALIDATOR_HOME="library/xmlvalidator-${XMLVALIDATOR_VERSION}"
YUI_COMPRESSOR_HOME="library/yuicompressor-${YUI_COMPRESSOR_VERSION}"
HTML_COMPRESSOR_HOME="library/htmlcompressor-${HTML_COMPRESSOR_VERSION}"
OUT_DIR="_generated"

# jars
SAXON_HE_JAR="${SAXON_HE_HOME}/saxon-he-${SAXON_HE_VERSION}.jar"
XML_RESOLVER_JAR="${SAXON_HE_HOME}/xmlresolver-${XML_RESOLVER_VERSION}.jar"
YUI_COMPRESSOR_JAR="${YUI_COMPRESSOR_HOME}/yuicompressor-${YUI_COMPRESSOR_VERSION}.jar"
HTML_COMPRESSOR_JAR="${HTML_COMPRESSOR_HOME}/htmlcompressor-${HTML_COMPRESSOR_VERSION}.jar"

# Maak output map
mkdir -p "$OUT_DIR"

# verwerk XML-bestanden
for f in data/*.xml; do
    echo "Processing $f..."
    # XML validatie (indien nodig, uitcommentariÃ«ren om te activeren)
    # java -cp "$XMLVALIDATOR_HOME" be.bruggeman.cv.XmlValidator data/schema/tutorial.xsd "$f"

    # HTML generatie via XSLT
    java -cp "$SAXON_HE_JAR:$XML_RESOLVER_JAR" net.sf.saxon.Transform -s:"$f" -xsl:style/tutorial.xsl basedir="$OUT_DIR"

    # HTML minify (optioneel)
    # java -jar "$HTML_COMPRESSOR_JAR" "$OUT_DIR/cv.html" -o "$OUT_DIR/cv.min.html"
    # rm -f "$OUT_DIR/cv.html"
    # mv "$OUT_DIR/cv.min.html" "$OUT_DIR/cv.html"
done

# kopieer assets
cp -r assets "$OUT_DIR/assets"

# minify CSS en JS
java -jar "$YUI_COMPRESSOR_JAR" "$OUT_DIR/assets/css/tutorial.css" -o "$OUT_DIR/assets/css/tutorial.min.css"
java -jar "$YUI_COMPRESSOR_JAR" "$OUT_DIR/assets/js/tutorial.js" -o "$OUT_DIR/assets/js/tutorial.min.js"

# verwijder onminified bestanden
rm -f "$OUT_DIR/assets/css/tutorial.css"
rm -f "$OUT_DIR/assets/js/tutorial.js"

echo "Klaar."
